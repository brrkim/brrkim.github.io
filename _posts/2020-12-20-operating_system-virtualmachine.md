---
title: "가상머신"
date: 2020-12-20 20:46:28 -0400
marp: true
categories: OS 운영체제 virtualmachine 가상머신
---

# 1. 운영체제

## 1.8. 가상머신

### 1.8.1 가상머신의 이해

- 하나의 HW에 다수의 운영체제를 설치하고 개별 컴퓨터 처럼 동작하도록 하는 프로그램
- 가상화 기술 구분 기준
  - Type 구분
    - Type1 (Natvie 또는 Bare Metal)
      - 하드웨어 위에 하이퍼바이저를 바로 설치 그 안에 여러 가상머신을 구현하는 방식
      - 하이퍼바이저가 하드웨어 에서 직접 구동
        - 하이퍼바이저(또는 버추얼 머신 모니터;VMM): 운영체제와 응용프로그램을 물리적 하드웨어에서 분리하는 프로세스
      - Xen, KVM
    - Type2
      - 하드웨어 위에 호스트 OS 올리고 그 위에 하이퍼바이저 올리기
        - VMware, Parallels DeskTop (Mac)
  - 전가상화, 반가상화
    - 전가상화: 각 가상머신이 하이퍼바이저를 통해 HW와 통신
      - 하이퍼바이저가 마치 하드웨어인 것처럼 동작. 가상머신의 OS는 자신이 가상 머신인 상태를 모름
      - vm의 OS는 기존 OS를 쓰면 됨
    - 반가상화:  각 가상머신에서 직접 HW와 통신
      - 각 가상머신에 설치되는 OS는 가상 머신인 경우 이를 인지하고 하이퍼바이저 명령을 '추가' 해서 하드웨어와 통신(추가만 할 뿐 HW와 직접통신)
      - 하이퍼바이저의 역할은 하드웨어 리소스관리
      - VM에 올라가는 OS를 수정해줘야함
    - 반가상화가 하드웨어와 직접 통신하다보니 가상머신 성능이 좋음
    - 그러나 요새는 HW성능이 좋아지다보니 전가상화기술을 선호
- 예시
  - VMware: 대중적인 가상 머신 프로그램, Type2
  - KVM: AWS 등에서 사용. Type1
    - 리눅스 커널 중 ioctl 시스템콜 사용. (하드웨어에 직접 명령하는 시스템콜)
      - ioctl로 vCPU 만들 수 있음
    - Intel-VT등 가상화 기능을 가진 CPU에서는 VMX root / VMX non-root 모드 존재
    - 각 모드별 protection ring 0~3 지원
    - 가상화 기능 사용하지 않을 경우엔 VMX root 모드 사용
    - KVM은 각 가상 시스템에 대응하는 KVM 프로세스 실행, KVM모듈(/dev/kvm)을 통해 vCPU사용
    - KVM프로세스 기반 게스트 커널(VMX non-root / ring 0 사용), QEMU장치 에뮬레이터가 로드됨
      - QEMU: IO Device 에뮬레이터
    - 게스트 커널 위에서 실행되는 응용프로그램은 VMX non-root / RIng 3 사용
    - 게스트 커널이 물리적 HW 자원 필요시, VM exit 발생하고 KVM 모듈에서 해당 요청 처리
    - 일반 HW 자원은 QEMU 장치 에뮬레이터에서 처리
      - QEMU 장치 에뮬레이터는 VMX root / RING 3 를 통해, 호스트 커널 요청 후, 해당 데이터는 공유 메모리를 통해 KVM 게스트 커널과 공유
  - Docker(컨테이너)
    - 가상머신은 컴퓨터 하드웨어를 추상화하는 반면 Docker는 커널을 추상화하였음
    - 운영체제 레벨에서 별도로 분리된 실행환경을 제공
    - 리눅스 컨테이너 기술이므로, MacOS나 Windows에 설치할 경우 가상머신 기반 제공

- 가상머신 총정리
  - Type1(Bare-Metal 방식)이 가장 성능이 좋음
    - HW 직접 엑세스하기 때문
    - AWS도 Type1 이용(KVM)
  - Docker는 경량 이미지로 **실행환경**을 통째로 백업, 실행 가능
- 참고
  - JVM
    - 응용프로그램 가상화
    - JAVA 컴파일러는 CPU Dependancy를 가지지 않는 ByteCode를 새엇ㅇ
    - 이 파일을 JVM에서 실행함
    - 각 운영체제를 위한 JVM 프로그램 존재

